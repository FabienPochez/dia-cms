version: '3'

services:
  payload:
    image: node:18-alpine
    user: "1000:1000"
    ports:
      - "127.0.0.1:3000:3000"
    volumes:
      - .:/app:ro
      - /tmp/empty-git:/app/.git
      - ./scripts:/app/scripts
      - ./payload/utils:/app/payload/utils
      - /srv/media:/srv/media:rw
    read_only: true
    tmpfs:
      - /tmp
    working_dir: /app/
    command:
      - sh
      - -c
      - |
        # Skip package installation if already installed (faster startup, avoids network issues)
        (which ffmpeg >/dev/null 2>&1 || echo "âš ï¸  ffmpeg not found, skipping install (non-critical)") && \
        if [ -f /app/node_modules/.bin/next ]; then \
          echo "âœ… node_modules exists, skipping install"; \
        else \
          echo "âš ï¸  node_modules/.bin/next not found, but skipping npm install (firewall blocked)"; \
        fi && \
        if [ ! -d .next ]; then \
          echo "Error: missing .next build artifacts. Run 'docker compose --profile build run --rm payload-build' first."; \
          exit 1; \
        fi && \
        npm run start
    environment:
      NODE_ENV: production
      NODE_OPTIONS: --max_old_space_size=1536
      NPM_CONFIG_PRODUCTION: "false"
    depends_on:
      - mongo
      # - postgres
    env_file:
      - .env
    networks:
      - default
      

  # WARNING: payload-dev must NOT be used in production (runs as root, writable mounts)
  payload-dev:
    image: node:18-alpine
    profiles:
      - dev
    ports:
      - '3300:3000'
    volumes:
      - .:/app
      - ./node_modules:/app/node_moduleses
      - ./scripts:/app/scripts
      - ./payload/utils:/app/payload/utils
      - /srv/media:/srv/media
    working_dir: /app/
    command:
      - sh
      - -c
      - |
        apk add --no-cache ffmpeg libheif libde265 && \
        npm install --include=dev && \
        rm -rf .next && \
        npm run dev
    environment:
      NODE_ENV: development
      NODE_OPTIONS: --max_old_space_size=1536
      NPM_CONFIG_PRODUCTION: "false"
    env_file:
      - .env
    networks:
      - default


  # WARNING: payload-build must NOT be used in production (runs as root, writable mounts)
  payload-build:
    image: node:18-alpine
    profiles:
      - build
    volumes:
      - .:/app
      - ./scripts:/app/scripts
      - ./payload/utils:/app/payload/utils
      - /srv/media:/srv/media
    working_dir: /app/
    command:
      - sh
      - -c
      - |
        apk add --no-cache ffmpeg libheif libde265 || echo "âš ï¸  Some packages may not install (non-critical)" && \
        corepack enable pnpm && \
        echo "ðŸ§¹ Cleaning previous build artifacts..." && \
        rm -rf .next node_modules && \
        echo "ðŸ“¦ Installing dependencies with pnpm (updating lockfile)..." && \
        pnpm install && \
        echo "ðŸ”¨ Building application..." && \
        pnpm run build && \
        echo "âœ… Build complete!"
    env_file:
      - .env
    networks:
      - default

  jobs:
    build:
      context: .
      dockerfile: Dockerfile.jobs
    restart: "no"  # Ephemeral - never auto-restart
    working_dir: /app
    user: "1000:1000"  # Non-root user (node user)
    volumes:
      - .:/app:ro  # Read-only repository mount
      - /srv/media:/srv/media:rw  # Read-write media access
      # SECURITY: Mount only the specific SSH key needed for rsync (not entire .ssh directory)
      # Mount to /home/node/.ssh/ (node user's home in node:18-alpine, uid 1000)
      - /home/fab/.ssh/id_ed25519:/home/node/.ssh/id_ed25519:ro  # SSH private key (read-only)
      - /home/fab/.ssh/id_ed25519.pub:/home/node/.ssh/id_ed25519.pub:ro  # SSH public key (read-only)
      - /home/fab/.ssh/config:/home/node/.ssh/config:ro  # SSH config (read-only)
    command:
      - sh
      - -c
      - |
        # Ensure .ssh directory exists with correct permissions
        mkdir -p /home/node/.ssh && chmod 700 /home/node/.ssh && chmod 600 /home/node/.ssh/id_ed25519 2>/dev/null || true
        # Add archive host to known_hosts to suppress warning (if not already present)
        ssh-keyscan -p 23 u476522.your-storagebox.de 2>/dev/null >> /home/node/.ssh/known_hosts 2>/dev/null || true
        chmod 644 /home/node/.ssh/known_hosts 2>/dev/null || true
        echo "jobs image ready"
    env_file:
      - .env
    environment:
      # SECURITY: Identifier for authorized jobs container (allows rsyncPull execution)
      - CONTAINER_TYPE=jobs
    networks:
      - default



  # Ensure your DATABASE_URI uses 'mongo' as the hostname ie. mongodb://mongo/my-db-name
  mongo:
    image: mongo:8.2
    ports:
      - '127.0.0.1:27017:27017'  # SECURITY: Bind to localhost only, not 0.0.0.0
    command:
      - --storageEngine=wiredTiger
      - --wiredTigerCacheSizeGB=0.75
    volumes:
      - data:/data/db
    logging:
      driver: none

  # Uncomment the following to use postgres
  # postgres:
  #   restart: always
  #   image: postgres:latest
  #   volumes:
  #     - pgdata:/var/lib/postgresql/data
  #   ports:
  #     - "5432:5432"

volumes:
  data:
  # pgdata:
  node_modules:


