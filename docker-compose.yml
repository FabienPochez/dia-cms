version: '3'

services:
  payload:
    image: node:18-alpine
    ports:
      - '3000:3000'
    volumes:
      - .:/app
      - node_modules:/app/node_modules
      - ./scripts:/app/scripts
      - ./payload/utils:/app/payload/utils
      - /srv/media:/srv/media
    working_dir: /app/
    command:
      - sh
      - -c
      - |
        apk add --no-cache ffmpeg libheif libde265 && \
        npm install --include=dev && \
        if [ ! -d .next ]; then \
          echo "Error: missing .next build artifacts. Run 'docker compose --profile build run --rm payload-build' first."; \
          exit 1; \
        fi && \
        npm run start
    environment:
      NODE_ENV: production
      NODE_OPTIONS: --max_old_space_size=1536
      NPM_CONFIG_PRODUCTION: "false"
    depends_on:
      - mongo
      # - postgres
    env_file:
      - .env
    networks:
      - default
      - libretime_default

  payload-dev:
    image: node:18-alpine
    profiles:
      - dev
    ports:
      - '3300:3000'
    volumes:
      - .:/app
      - node_modules:/app/node_modules
      - ./scripts:/app/scripts
      - ./payload/utils:/app/payload/utils
      - /srv/media:/srv/media
    working_dir: /app/
    command:
      - sh
      - -c
      - |
        apk add --no-cache ffmpeg libheif libde265 && \
        npm install --include=dev && \
        rm -rf .next && \
        npm run dev
    environment:
      NODE_ENV: development
      NODE_OPTIONS: --max_old_space_size=1536
      NPM_CONFIG_PRODUCTION: "false"
    env_file:
      - .env
    networks:
      - default
      - libretime_default

  payload-build:
    image: node:18-alpine
    profiles:
      - build
    volumes:
      - .:/app
      - node_modules:/app/node_modules
      - ./scripts:/app/scripts
      - ./payload/utils:/app/payload/utils
      - /srv/media:/srv/media
    working_dir: /app/
    command:
      - sh
      - -c
      - |
        apk add --no-cache ffmpeg libheif libde265 && \
        npm install --include=dev && \
        rm -rf .next && \
        npm run build
    env_file:
      - .env
    networks:
      - default
      - libretime_default
  dev-scripts:
    image: node:18
    restart: unless-stopped
    working_dir: /app
    # SECURITY: Run as non-root user (UID 1000, GID 1000)
    user: "1000:1000"
    volumes:
      - .:/app
      - /srv/media:/srv/media
      # SECURITY: Removed docker.sock mount - not needed and was a critical security risk
      # SECURITY: Removed /root/.ssh mount - not needed if running as non-root
      # Note: SSH keys should be managed differently if rsync needs them
    command: 
      - sh
      - -c
      # SECURITY: Install only what's needed (removed docker.io)
      - "apt-get update -qq && apt-get install -y -qq rsync postgresql-client > /dev/null 2>&1 && tail -f /dev/null"
    env_file:
      - .env
    networks:
      - default
      - libretime_default


  # Ensure your DATABASE_URI uses 'mongo' as the hostname ie. mongodb://mongo/my-db-name
  mongo:
    image: mongo:latest
    ports:
      - '127.0.0.1:27017:27017'  # SECURITY: Bind to localhost only, not 0.0.0.0
    command:
      - --storageEngine=wiredTiger
      - --wiredTigerCacheSizeGB=0.75
    volumes:
      - data:/data/db
    logging:
      driver: none

  # Uncomment the following to use postgres
  # postgres:
  #   restart: always
  #   image: postgres:latest
  #   volumes:
  #     - pgdata:/var/lib/postgresql/data
  #   ports:
  #     - "5432:5432"

volumes:
  data:
  # pgdata:
  node_modules:

networks:
  libretime_default:
    external: true
