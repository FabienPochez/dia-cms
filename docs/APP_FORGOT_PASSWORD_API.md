# App Forgot Password API

**Endpoint**: `POST /api/app-forgot-password`  
**Purpose**: Request password reset email for Dia Radio app/web accounts  
**Status**: âœ… Implemented

---

## Overview

This endpoint allows users to request a password reset email for their Dia Radio app account. The email contains a reset link that points to `dia-web.vercel.app` (separate from the admin panel flow which uses `content.diaradio.live`).

**Key Features:**
- Custom email template with app-specific messaging
- Rate limiting (5 attempts per minute per IP+email)
- Security: Generic success response to prevent user enumeration
- Token expiry: 1 hour
- Single-use tokens (invalidated after reset)

---

## Request

### Endpoint
```
POST /api/app-forgot-password
```

### Headers
```
Content-Type: application/json
```

### Request Body
```json
{
  "email": "user@example.com"
}
```

**Fields:**
- `email` (string, required): User's email address

### Example Request
```bash
curl -X POST https://content.diaradio.live/api/app-forgot-password \
  -H "Content-Type: application/json" \
  -d '{"email": "user@example.com"}'
```

---

## Response

### Success Response
**Status**: `200 OK`

```json
{
  "success": true
}
```

**Note**: The response is always `{ success: true }` regardless of whether the email exists in the system. This prevents user enumeration attacks.

### Error Responses

#### 400 Bad Request - Missing Email
```json
{
  "error": "Email is required"
}
```

#### 400 Bad Request - Invalid Email Format
```json
{
  "error": "Invalid email format"
}
```

#### 429 Too Many Requests - Rate Limit Exceeded
```json
{
  "error": "Too many password reset requests. Please try again later.",
  "retryAfter": 45
}
```

**Headers:**
- `Retry-After`: Number of seconds until rate limit resets

#### 500 Internal Server Error
```json
{
  "error": "Failed to send password reset email"
}
```

---

## Rate Limiting

**Limit**: 5 requests per minute per IP address + email combination

**Behavior:**
- Rate limit is tracked by IP address and email address
- Exceeding the limit returns `429 Too Many Requests`
- Rate limit window resets after 1 minute
- `Retry-After` header indicates seconds until reset

**Example:**
- User can request reset for `user@example.com` 5 times per minute from the same IP
- Different IPs have separate rate limit counters
- Different emails from the same IP have separate counters

---

## Email Template

### Subject
```
Reset your Dia Radio app account password
```

### Content
- Clear messaging about "Dia Radio app account"
- Reset button and link: `https://dia-web.vercel.app/reset-password?token={token}`
- Expiry notice: "This link will expire in 1 hour"
- Security notice: "If you did not request a password reset, please ignore this email"

### Reset Link Format
```
https://dia-web.vercel.app/reset-password?token={token}
```

**Token:**
- 64-character hexadecimal string
- Generated using `crypto.randomBytes(32)`
- Stored in user document as `resetPasswordToken`
- Expires after 1 hour (stored as `resetPasswordExpiration`)

---

## Password Reset Flow

### Step 1: Request Reset Email
```bash
POST /api/app-forgot-password
{
  "email": "user@example.com"
}
```

### Step 2: User Receives Email
- Email sent to user's registered address
- Contains reset link: `https://dia-web.vercel.app/reset-password?token={token}`

### Step 3: User Clicks Link
- Frontend navigates to reset password page
- Extracts `token` from URL query parameter

### Step 4: Submit New Password
```bash
POST /api/users/reset-password
{
  "token": "abc123...",
  "password": "newSecurePassword123!"
}
```

**Note**: The reset password endpoint (`POST /api/users/reset-password`) is Payload's built-in endpoint and works with tokens generated by either:
- App forgot password flow (this endpoint)
- Admin forgot password flow (`/api/users/forgot-password`)

---

## Security Considerations

### User Enumeration Prevention
- Always returns `{ success: true }` even if email doesn't exist
- Prevents attackers from discovering which emails are registered

### Rate Limiting
- Prevents email spam/abuse
- Limits: 5 requests per minute per IP+email
- Returns `429` with `Retry-After` header when exceeded

### Token Security
- Cryptographically secure random token (64 hex characters)
- Short expiry (1 hour)
- Single-use (invalidated after successful reset)
- Stored securely in database

### Email Security
- HTTPS reset links only
- Clear expiry notice
- Security warning if not requested

---

## Integration Examples

### JavaScript/TypeScript (Fetch API)
```typescript
async function requestPasswordReset(email: string) {
  try {
    const response = await fetch('https://content.diaradio.live/api/app-forgot-password', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ email }),
    })

    const data = await response.json()

    if (response.ok) {
      console.log('Password reset email sent')
      return { success: true }
    } else {
      if (response.status === 429) {
        console.error('Rate limited. Retry after:', data.retryAfter, 'seconds')
      } else {
        console.error('Error:', data.error)
      }
      return { success: false, error: data.error }
    }
  } catch (error) {
    console.error('Network error:', error)
    return { success: false, error: 'Network error' }
  }
}
```

### Vue.js Example
```vue
<template>
  <form @submit.prevent="handleForgotPassword">
    <input v-model="email" type="email" placeholder="Email" required />
    <button type="submit" :disabled="loading">
      {{ loading ? 'Sending...' : 'Send Reset Email' }}
    </button>
    <p v-if="message">{{ message }}</p>
  </form>
</template>

<script setup>
import { ref } from 'vue'

const email = ref('')
const loading = ref(false)
const message = ref('')

async function handleForgotPassword() {
  loading.value = true
  message.value = ''

  try {
    const response = await fetch('https://content.diaradio.live/api/app-forgot-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: email.value }),
    })

    const data = await response.json()

    if (response.ok) {
      message.value = 'Password reset email sent! Check your inbox.'
    } else {
      message.value = data.error || 'Failed to send reset email'
    }
  } catch (error) {
    message.value = 'Network error. Please try again.'
  } finally {
    loading.value = false
  }
}
</script>
```

---

## Testing

### Development Testing
1. Send request to endpoint with valid email
2. Check server logs for email sending confirmation
3. In development (mock mode), check logs for email preview URL
4. Verify email contains correct reset link format

### Production Testing
1. Send request with valid registered email
2. Check user's inbox for reset email
3. Verify email subject and content
4. Click reset link and verify it navigates to `dia-web.vercel.app/reset-password?token=...`
5. Test rate limiting by sending 6+ requests in 1 minute

---

## Related Endpoints

### Reset Password
- **Endpoint**: `POST /api/users/reset-password`
- **Body**: `{ token: string, password: string }`
- **Purpose**: Submit new password using reset token
- **Documentation**: Payload CMS built-in endpoint

### Admin Forgot Password
- **Endpoint**: `POST /api/users/forgot-password`
- **Purpose**: Admin panel forgot password flow
- **Email Link**: `https://content.diaradio.live/admin/reset-password?token=...`
- **Note**: Separate from app forgot password flow

---

## Implementation Details

**File**: `src/app/api/app-forgot-password/route.ts`

**Dependencies:**
- `@/lib/rateLimiter` - Rate limiting utility
- `payload` - Payload CMS instance
- `crypto` - Node.js crypto module for token generation

**Rate Limiter**: `forgotPasswordRateLimiter` (5 attempts/min per IP+email)

**Email Sending**: Uses `payload.sendEmail()` with custom HTML template

---

## Changelog

**2025-01-XX** - Initial implementation
- Created app forgot password endpoint
- Custom email template with `dia-web.vercel.app` links
- Rate limiting (5 attempts/min per IP+email)
- Security: Generic success response to prevent user enumeration

