================================================================================
SEARCH INDEX PREPARATION - PLANNING PHASE COMPLETE ‚úÖ
================================================================================

Date: 2025-10-27
Phase: Planning Only (No indexes created yet)
Status: Ready for Implementation Approval

================================================================================
EXECUTIVE SUMMARY
================================================================================

‚úÖ WHAT WAS DONE:
  ‚Ä¢ Inspected schemas for shows, episodes, and hosts collections
  ‚Ä¢ Audited all existing indexes (18 total across 3 collections)
  ‚Ä¢ Identified 3 missing indexes needed for search MVP
  ‚Ä¢ Created inspection script (inspect-search-indexes.js)
  ‚Ä¢ Created index creation script (create-search-indexes-mvp.js)
  ‚Ä¢ Tested creation script with dry-run (successful)
  ‚Ä¢ Documented everything in comprehensive planning docs
  ‚Ä¢ Updated CHANGELOG with planning section

‚úÖ KEY FINDING:
  ‚Ä¢ episodes.show_1 already exists! (auto-created by Payload)
  ‚Ä¢ Only need to create 3 indexes instead of 4

‚ùå NOT DONE (Intentionally):
  ‚Ä¢ No indexes were created (planning only, as requested)
  ‚Ä¢ No text indexes (deferred to Phase 2)
  ‚Ä¢ No production changes made

================================================================================
CURRENT STATE (BASELINE - 2025-10-27)
================================================================================

Shows Collection:         4 indexes
  ‚úÖ _id, updatedAt, slug (unique), createdAt
  ‚ùå Missing: title, subtitle, description indexes

Episodes Collection:      10 indexes
  ‚úÖ _id, createdAt, updatedAt, show, libretimeTrackId, 
     libretimeFilepathRelative, scheduledAt, scheduledEnd,
     idx_schedStart_end, slug (unique+sparse)
  ‚úÖ Already has: show_1 (JOIN FIELD - no action needed!)
  ‚ùå Missing: genres index

Hosts Collection:         4 indexes
  ‚úÖ _id, updatedAt, createdAt, slug (unique+sparse)
  ‚ùå Missing: name index

Total Current Indexes:    18
Text Indexes:             0 (none present)

================================================================================
PROPOSED CHANGES (3 NEW INDEXES)
================================================================================

1. episodes.genres_1
   Type:    Multikey index (array field)
   Keys:    { genres: 1 }
   Purpose: Filter episodes by genre (array lookup)
   Query:   db.episodes.find({ genres: { $in: [genreId1, genreId2] } })

2. shows.title_1_subtitle_1_description_1
   Type:    Compound index (3 fields)
   Keys:    { title: 1, subtitle: 1, description: 1 }
   Purpose: Text search on show metadata (starts-with/contains)
   Query:   db.shows.find({ title: /^search/i })

3. hosts.name_1
   Type:    Single-field index
   Keys:    { name: 1 }
   Purpose: Search hosts by name
   Query:   db.hosts.find({ name: /^search/i })

Total After Creation:     21 indexes (+3)

================================================================================
FILES CREATED
================================================================================

üìÑ Planning Documents:
   docs/SEARCH_INDEX_PLAN_README.md           (Navigation & Quick Start)
   docs/SEARCH_INDEX_PLAN_SUMMARY.md          (Executive Summary, 5-min)
   docs/SEARCH_INDEX_PLAN_MVP.md              (Full Plan, 20-min, 12 sections)
   docs/SEARCH_INDEX_BASELINE.txt             (Current state snapshot)
   docs/SEARCH_INDEX_PLANNING_COMPLETE.txt    (This file)

üîß Scripts:
   scripts/db/inspect-search-indexes.js       (Audit existing indexes)
   scripts/db/create-search-indexes-mvp.js    (Create missing indexes)

üìù CHANGELOG:
   CHANGELOG.md (lines 18-58)                 (Planning section added)

================================================================================
NEXT STEPS (WHEN READY TO IMPLEMENT)
================================================================================

1. Review Planning Docs
   ‚Üí Start with: docs/SEARCH_INDEX_PLAN_SUMMARY.md
   ‚Üí Full details: docs/SEARCH_INDEX_PLAN_MVP.md

2. Verify Baseline (Optional)
   ‚Üí docker compose exec payload node scripts/db/inspect-search-indexes.js
   ‚Üí Confirm state hasn't changed since planning

3. Execute Index Creation
   ‚Üí docker compose exec payload node scripts/db/create-search-indexes-mvp.js --dry-run
   ‚Üí docker compose exec payload node scripts/db/create-search-indexes-mvp.js

4. Verify Creation
   ‚Üí docker compose exec payload node scripts/db/inspect-search-indexes.js
   ‚Üí Should show 21 total indexes (18 + 3)

5. Smoke Test (Optional)
   ‚Üí Connect to MongoDB and test with explain()
   ‚Üí Verify IXSCAN usage instead of COLLSCAN

6. Update CHANGELOG
   ‚Üí Move planning section to new dated entry
   ‚Üí Document actual results and performance improvements

================================================================================
ROLLBACK (IF NEEDED)
================================================================================

If indexes cause issues, rollback is simple:

  docker compose exec mongo mongosh dia-cms
  
  db.episodes.dropIndex('genres_1');
  db.shows.dropIndex('title_1_subtitle_1_description_1');
  db.hosts.dropIndex('name_1');

================================================================================
RISK ASSESSMENT
================================================================================

Risk Level: üü¢ LOW

Why Low Risk?
  ‚Ä¢ Small dataset (~1000 episodes, ~40 shows, ~50 hosts)
  ‚Ä¢ Background index builds (non-blocking, MongoDB 4.2+)
  ‚Ä¢ Minimal write throughput impact (<5% expected)
  ‚Ä¢ Simple rollback (3 dropIndex commands)
  ‚Ä¢ No text indexes (simple ascending indexes only)

Limitations (Acceptable for MVP):
  ‚Ä¢ Regex leading wildcard queries won't use indexes efficiently
    Example: db.shows.find({ title: /.*music/i }) (contains, leading wildcard)
  ‚Ä¢ No relevance scoring (deferred to Phase 2 text indexes)
  ‚Ä¢ Compound index won't optimize subtitle-only queries

================================================================================
SUCCESS CRITERIA
================================================================================

‚úÖ Planning Phase (Complete):
   [x] Schema audit for shows, episodes, hosts
   [x] Baseline index capture (SEARCH_INDEX_BASELINE.txt)
   [x] Script creation (inspect + create scripts)
   [x] Dry-run testing (successful, 3 indexes would be created)
   [x] Documentation (README, summary, full plan, baseline)
   [x] CHANGELOG entry (planning section)
   [x] Risk assessment

‚è∏Ô∏è Implementation Phase (Awaiting Approval):
   [ ] Team review of planning docs
   [ ] Approval to proceed
   [ ] Execute index creation script
   [ ] Verify with inspection script
   [ ] Smoke test representative queries
   [ ] Update CHANGELOG with results
   [ ] Archive planning docs for reference

================================================================================
QUERY PERFORMANCE EXPECTATIONS
================================================================================

After Index Creation:

Episode Genre Filter:
  ‚Ä¢ Before: Collection scan (~1000 docs)
  ‚Ä¢ After:  Multikey index scan (genres_1)
  ‚Ä¢ Speedup: 5-50x faster (depends on selectivity)

Show Text Search (starts-with):
  ‚Ä¢ Before: Collection scan (~40 docs)
  ‚Ä¢ After:  Compound index prefix scan (title_1_subtitle_1_description_1)
  ‚Ä¢ Speedup: 5-20x faster (small collection, but consistent)

Host Name Search:
  ‚Ä¢ Before: Collection scan (~50 docs)
  ‚Ä¢ After:  Single-field index scan (name_1)
  ‚Ä¢ Speedup: 3-10x faster

Informal Timing Goal: <50ms for typical searches

================================================================================
PHASE 2 PREVIEW (TEXT INDEXES)
================================================================================

Deferred Features (Not in MVP):
  ‚Ä¢ Full-text search with $text operator
  ‚Ä¢ Relevance ranking with $meta: "textScore"
  ‚Ä¢ Language-specific stemming (English)
  ‚Ä¢ Better wildcard/contains query performance

Example Text Index (Phase 2):
  db.shows.createIndex(
    { title: "text", subtitle: "text", description: "text" },
    { weights: { title: 10, subtitle: 5, description: 1 } }
  )

When to Upgrade to Phase 2:
  ‚Ä¢ When regex performance becomes insufficient
  ‚Ä¢ When relevance ranking is required
  ‚Ä¢ When user search expectations increase

================================================================================
CONTACT & REFERENCES
================================================================================

Planning Documents:
  ‚Ä¢ README:  docs/SEARCH_INDEX_PLAN_README.md
  ‚Ä¢ Summary: docs/SEARCH_INDEX_PLAN_SUMMARY.md
  ‚Ä¢ Full:    docs/SEARCH_INDEX_PLAN_MVP.md
  ‚Ä¢ Baseline: docs/SEARCH_INDEX_BASELINE.txt

Scripts:
  ‚Ä¢ Inspect: scripts/db/inspect-search-indexes.js
  ‚Ä¢ Create:  scripts/db/create-search-indexes-mvp.js

Related Work:
  ‚Ä¢ CHANGELOG: Line 18-58 (Planning section)
  ‚Ä¢ Oct 21, 2025: Database indexing optimization (scheduling)

MongoDB Docs:
  ‚Ä¢ Index Strategies: https://www.mongodb.com/docs/manual/applications/indexes/
  ‚Ä¢ Multikey Indexes: https://www.mongodb.com/docs/manual/core/index-multikey/
  ‚Ä¢ Compound Indexes: https://www.mongodb.com/docs/manual/core/index-compound/

================================================================================
SUMMARY
================================================================================

‚úÖ Planning is COMPLETE and documented
‚úÖ Scripts are CREATED and tested (dry-run successful)
‚úÖ Baseline is CAPTURED (SEARCH_INDEX_BASELINE.txt)
‚úÖ Risk is LOW (small dataset, simple rollback)
‚úÖ Impact is POSITIVE (5-50x query speedup expected)

Ready for: Implementation approval and execution
Next action: Review docs and approve for production

================================================================================
END OF PLANNING REPORT
================================================================================



