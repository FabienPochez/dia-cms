#!/bin/bash
# Monitor for docker malware file recreation
# Run this script in the background or as a systemd service

MONITOR_DIRS=("/srv/payload" "/var/tmp" "/tmp")
MALWARE_FILES=("dockerd" "docker-daemon" "sex.sh")
LOG_FILE="/var/log/docker-malware-monitor.log"
ALERT_EMAIL="${ALERT_EMAIL:-}"  # Set if you want email alerts

# Create log directory if it doesn't exist
mkdir -p "$(dirname "$LOG_FILE")"

log() {
    echo "[$(date -Is)] $1" | tee -a "$LOG_FILE"
}

alert() {
    local message="$1"
    log "ðŸš¨ ALERT: $message"
    
    # Log to syslog
    logger -t docker-malware-monitor "ALERT: $message"
    
    # Send email if configured
    if [ -n "$ALERT_EMAIL" ]; then
        echo "$message" | mail -s "MALWARE DETECTED: Docker malware" "$ALERT_EMAIL" 2>/dev/null || true
    fi
    
    # Check for running processes
    local proc_info=$(ps aux | grep -E "dockerd|docker-daemon" | grep -v grep | grep -v "/usr/bin/dockerd" | head -5)
    if [ -n "$proc_info" ]; then
        log "âš ï¸  Suspicious processes found:"
        echo "$proc_info" | while read line; do
            log "   $line"
        done
    fi
}

# Check if file exists in a directory
check_file() {
    local dir="$1"
    local file="$2"
    local full_path="$dir/$file"
    
    if [ -f "$full_path" ]; then
        local file_info=$(stat "$full_path" 2>/dev/null)
        local file_size=$(stat -c%s "$full_path" 2>/dev/null)
        local file_time=$(stat -c%y "$full_path" 2>/dev/null)
        local file_md5=$(md5sum "$full_path" 2>/dev/null | cut -d' ' -f1)
        
        alert "Malware file detected: $full_path (Size: $file_size bytes, Modified: $file_time, MD5: $file_md5)"
        
        # Get process info if file is executable
        if [ -x "$full_path" ]; then
            local proc_info=$(lsof "$full_path" 2>/dev/null)
            if [ -n "$proc_info" ]; then
                log "   File is being used by processes:"
                echo "$proc_info" | while read line; do
                    log "   $line"
                done
            fi
        fi
        
        return 1
    fi
    return 0
}

# Check all malware files in all directories
check_all_files() {
    local found=0
    for dir in "${MONITOR_DIRS[@]}"; do
        [ ! -d "$dir" ] && continue
        for file in "${MALWARE_FILES[@]}"; do
            if ! check_file "$dir" "$file"; then
                found=1
            fi
        done
    done
    return $found
}

# Initial check
log "Starting docker malware monitoring"
log "Monitoring directories: ${MONITOR_DIRS[*]}"
log "Monitoring files: ${MALWARE_FILES[*]}"
check_all_files

# Use polling method (inotifywait not available)
log "Using polling method (checking every 30 seconds)"
while true; do
    sleep 30
    check_all_files
done
