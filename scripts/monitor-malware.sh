#!/bin/bash
# Monitor for malware file recreation
# Run this script in the background or as a systemd service

MONITOR_DIR="/srv/payload"
MALWARE_FILE="sex.sh"
LOG_FILE="/var/log/malware-monitor.log"
ALERT_EMAIL="${ALERT_EMAIL:-}"  # Set if you want email alerts

# Create log directory if it doesn't exist
mkdir -p "$(dirname "$LOG_FILE")"

log() {
    echo "[$(date -Is)] $1" | tee -a "$LOG_FILE"
}

alert() {
    local message="$1"
    log "ALERT: $message"
    
    # Log to syslog
    logger -t malware-monitor "ALERT: $message"
    
    # Send email if configured
    if [ -n "$ALERT_EMAIL" ]; then
        echo "$message" | mail -s "MALWARE DETECTED: $MALWARE_FILE" "$ALERT_EMAIL" 2>/dev/null || true
    fi
}

# Check if file exists
check_file() {
    if [ -f "$MONITOR_DIR/$MALWARE_FILE" ]; then
        local file_info=$(stat "$MONITOR_DIR/$MALWARE_FILE" 2>/dev/null)
        local file_size=$(stat -c%s "$MONITOR_DIR/$MALWARE_FILE" 2>/dev/null)
        local file_time=$(stat -c%y "$MONITOR_DIR/$MALWARE_FILE" 2>/dev/null)
        
        alert "Malware file detected: $MONITOR_DIR/$MALWARE_FILE (Size: $file_size bytes, Modified: $file_time)"
        
        # Optionally delete the file automatically
        # Uncomment the next line if you want auto-deletion
        # rm -f "$MONITOR_DIR/$MALWARE_FILE" && log "File deleted automatically"
        
        return 1
    fi
    return 0
}

# Initial check
log "Starting malware monitoring for $MONITOR_DIR/$MALWARE_FILE"
check_file

# Use inotifywait if available, otherwise use polling
if command -v inotifywait >/dev/null 2>&1; then
    log "Using inotifywait for real-time monitoring"
    while true; do
        inotifywait -m -e create,modify,moved_to "$MONITOR_DIR" 2>/dev/null | while read -r directory event filename; do
            if [ "$filename" = "$MALWARE_FILE" ]; then
                check_file
            fi
        done
        sleep 1
    done
else
    log "Using polling method (inotifywait not available)"
    while true; do
        sleep 30  # Check every 30 seconds
        check_file
    done
fi

